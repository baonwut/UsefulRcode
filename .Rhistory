setwd("d:/UsefulRcode")
getwd()
id<-c("CFF_RE_IF1506","CFF_RE_IF1505")
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Klist
substr(Klist,27,unlist(lapply(Klist,nchar))-2)
lapply(Klist,nchar)
grep("=",Klist)
grep("[=]",Klist,perl=T)
lapply(Klist,grep,"[=]",perl=T)
lapply(Klist,grep)
lapply(Klist,grep,pattern="=",)
lapply(Klist,grep,pattern="=")
lapply(Klist,grepl,pattern="=")
nchar(Klist)
strsplit(Klist,"=")
unlist(strsplit(Klist,"="))
unlist(lappy(Klist,strsplit"="))
unlist(lapply(Klist,strsplit"="))
unlist(lapply(Klist,strsplit,"="))
lapply(Klist,strsplit,"=")
nchar(lapply(Klist,strsplit,"="))
lapply(lapply(Klist,strsplit,"="),nchar)
lapply(lapply(Klist,strsplit,"=")[1],nchar)
lapply(lapply(Klist,strsplit,"=")[1][1],nchar)
lapply(lapply(Klist,strsplit,"=")[2][1],nchar)
nchar(lapply(Klist,strsplit,"=")[2][1])
library(stringr,lib.loc="d:/R")
stringr(Klist,"=")
str_match(Klist,"=")
strings <- c(" 219 733 8965", "329-293-8753 ", "banana", "595 794 7569",
"387 287 6718", "apple", "233.398.9187  ", "482 952 3315",
"239 923 8115", "842 566 4692", "Work: 579-499-7527", "$1000",
"Home: 543.355.3679")
strings
phone <- "([2-9][0-9]{2})[- .]([0-9]{3})[- .]([0-9]{4})"
phone
str_match(strings, phone)
fruit <- c("apple", "banana", "pear", "pineapple")
str_count(fruit, "a")
letters
grep("[a-z]", letters)
grep("[z-a]", letters)
str_count(fruit, c("a", "b", "p", "p"))
str_count(fruit, "p")
str_locate(Klist, "=")
str_locate(fruit, "a")
nchar(id)
x<-c("1","12")
nchar(x)
strsplist(Klist,"=")
strsplit(Klist,"=")
strsplit(Klist,"=")[1]
strsplit(Klist,"=")[1][1]
strsplit(Klist,"=")[1,1]
strsplit(Klist,"=")[1][1]
strsplit(Klist,"=")[[1]][1]
strsplit(Klist,"=")[[1]]
strsplit(Klist,"=")[[1]][1]
data.frame(strsplit(Klist,"="))
data.frame(unlist(strsplit(Klist,"=")))
data.frame(matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2))
matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)
matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)[1]
matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)[,1]
nchar(matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)[,1])
substr(Klist,18,nchar(matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)[,1]))
substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),byrow=T,ncol=2)[,1]))
Klist
id<-c("M0",id)
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Klist
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=6))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,14,15)]
id
id<-c("CFF_RE_IF1506" ,"CFF_RE_IF1505")
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=6))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,14,15)]
Klist
data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,14,15)]
Kdt
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,15:16)]
Kdt
id<-c("TA0","M0")
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""))}))
Klist
substr(Klist,12,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
substr(Klist,12,unlist(lapply(Klist,nchar))-2)
Klist<-substr(Klist,12,unlist(lapply(Klist,nchar))-2)
strsplit(Klist,"[,][=\"]",perl =T)
strsplit(Klist,"[,]|[=\"]",perl =T)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]",perl =T)),
byrow=T,ncol=30))
Kdt
Kdt<-data.frame(Kid,Kdt)
Kdt
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""))}))
Klist<-substr(Klist,12,unlist(lapply(Klist,nchar))-2)
Klist
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]",perl =T)),
byrow=T,ncol=30))
Kdt
Kdt<-Kdt[c(1,3,5:8,11:13,16:20)]
Kdt
names(Kdt)<-c("id","name","open","high","low","yesterdayClose",
"currentPice","clearing","yesterdayClearing",
"holdings","Amount",
"clearing","exchange","nameabbr","date")
names(Kdt)
names(Kdt)<-c("id","name",
"open","high","low","yesterdayClose",
"currentPice","clearing","yesterdayClearing",
"holdings","amount",
"exchange","nameabbr","date")
Kdt
realtimeK<-function(STOCKID,TYPE="stock"){
if(class(STOCKID)=="character"){id<-STOCKID}else{
id<-as.vector(unlist(STOCKID))}
if(TYPE=="stock"){
#K on sina
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep="")
)}))
Klist<-substr(Klist,22,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=33))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","stockname","todayOpen","yestClose",
"nowPrice","todayHigh",
"todayLow","buyPrice","sellPrice",
"volume","turnOver",
"buyOneAmount","buyOnePrice",
"buyTwoAmount","buyTwoPrice",
"buyThreeAmount","buyThreePrice",
"buyFourAmount","buyFourPrice",
"buyFiveAmount","buyFivePrice",
"sellOneAmount","sellOnePrice",
"sellTwoAmount","sellTwoPrice",
"sellThreeAmount","sellThreePrice",
"sellFourAmount","sellFourPrice",
"sellFiveAmount","sellFivePrice",
"Date","Time","mark")
Kdt<-transform(Kdt,
nowPrice=as.numeric(as.character(nowPrice)),
yestClose=as.numeric(as.character(yestClose)))
Kdt$nowPrice<-ifelse((Kdt$mark=="03") & (Kdt$nowPrice==0),
as.numeric(as.character(Kdt$yestClose)),
as.numeric(as.character(Kdt$nowPrice)))
#market capitalization
Klist1<-unlist(lapply(id,function(id){
readLines(paste("http://qt.gtimg.cn/r=0.8409869808238q=",
id,sep="")
)}))
Klist1<-substr(Klist1,16,unlist(lapply(Klist1,nchar))-2)
Kdt1<-data.frame(matrix(unlist(strsplit(Klist1,"~")),
byrow=T,ncol=48))
Kdt1<-Kdt1[,c(2,44,45)]
Kdt1<-data.frame(id,Kdt1)
names(Kdt1)<-c("id","stockid","MarketValue","TotalMarketValue")
#merge
Kdt<-merge(Kdt,Kdt1,by="id",all.x=T)
}
if(TYPE=="index"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=s_",id,sep=""),
encoding ="UTF-8")}))
Klist<-substr(Klist,23,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=6))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","indexname",
"currentPoints","currentPrice",
"changeRate",
"volume_hand","turnOver_million")
}
if(TYPE=="futuresIndex"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,15:16)]
names(Kdt)<-c("id","open","high","low",
"currentPice","Amount","turnover",
"holdings","clearing",
"yesterdayClose","yesterdayClearing")
}
if(TYPE=="futures"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""))}))
Klist<-substr(Klist,12,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]",perl =T)),
byrow=T,ncol=30))
Kdt<-Kdt[c(1,3,5:8,11:13,16:20)]
names(Kdt)<-c("id","name",
"open","high","low","yesterdayClose",
"currentPice","clearing","yesterdayClearing",
"holdings","amount",
"exchange","nameabbr","date")
}
Kdt
}
realtimeK<-function(STOCKID,TYPE="stock"){
if(class(STOCKID)=="character"){id<-STOCKID}else{
id<-as.vector(unlist(STOCKID))}
if(TYPE=="stock"){
#K on sina
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep="")
)}))
Klist<-substr(Klist,22,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=33))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","stockname","todayOpen","yestClose",
"nowPrice","todayHigh",
"todayLow","buyPrice","sellPrice",
"volume","turnOver",
"buyOneAmount","buyOnePrice",
"buyTwoAmount","buyTwoPrice",
"buyThreeAmount","buyThreePrice",
"buyFourAmount","buyFourPrice",
"buyFiveAmount","buyFivePrice",
"sellOneAmount","sellOnePrice",
"sellTwoAmount","sellTwoPrice",
"sellThreeAmount","sellThreePrice",
"sellFourAmount","sellFourPrice",
"sellFiveAmount","sellFivePrice",
"Date","Time","mark")
Kdt<-transform(Kdt,
nowPrice=as.numeric(as.character(nowPrice)),
yestClose=as.numeric(as.character(yestClose)))
Kdt$nowPrice<-ifelse((Kdt$mark=="03") & (Kdt$nowPrice==0),
as.numeric(as.character(Kdt$yestClose)),
as.numeric(as.character(Kdt$nowPrice)))
#market capitalization
Klist1<-unlist(lapply(id,function(id){
readLines(paste("http://qt.gtimg.cn/r=0.8409869808238q=",
id,sep="")
)}))
Klist1<-substr(Klist1,16,unlist(lapply(Klist1,nchar))-2)
Kdt1<-data.frame(matrix(unlist(strsplit(Klist1,"~")),
byrow=T,ncol=48))
Kdt1<-Kdt1[,c(2,44,45)]
Kdt1<-data.frame(id,Kdt1)
names(Kdt1)<-c("id","stockid","MarketValue","TotalMarketValue")
#merge
Kdt<-merge(Kdt,Kdt1,by="id",all.x=T)
}
if(TYPE=="index"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=s_",id,sep=""),
encoding ="UTF-8")}))
Klist<-substr(Klist,23,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=6))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","indexname",
"currentPoints","currentPrice",
"changeRate",
"volume_hand","turnOver_million")
}
if(TYPE=="futuresIndex"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,15:16)]
names(Kdt)<-c("id","open","high","low",
"currentPice","Amount","turnover",
"holdings","clearing",
"yesterdayClose","yesterdayClearing")
}
if(TYPE=="futures"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""))}))
Klist<-substr(Klist,12,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]",perl =T)),
byrow=T,ncol=30))
Kdt<-Kdt[c(1,3,5:8,11:13,16:20)]
names(Kdt)<-c("id","name",
"open","high","low","yesterdayClose",
"currentPice","clearing","yesterdayClearing",
"holdings","amount",
"exchange","nameabbr","date")
}
Kdt
}
id<-"M0"
realtimeK(id,YPE="futuresIndex")
realtimeK(id,TYPE="futuresIndex")
realtimeK(id,TYPE="futuresIndex")
realtimeK(id,TYPE="futures")
realtimeK<-function(STOCKID,TYPE="stock"){
if(class(STOCKID)=="character"){id<-STOCKID}else{
id<-as.vector(unlist(STOCKID))}
if(TYPE=="stock"){
#K on sina
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep="")
)}))
Klist<-substr(Klist,22,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=33))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","stockname","todayOpen","yestClose",
"nowPrice","todayHigh",
"todayLow","buyPrice","sellPrice",
"volume","turnOver",
"buyOneAmount","buyOnePrice",
"buyTwoAmount","buyTwoPrice",
"buyThreeAmount","buyThreePrice",
"buyFourAmount","buyFourPrice",
"buyFiveAmount","buyFivePrice",
"sellOneAmount","sellOnePrice",
"sellTwoAmount","sellTwoPrice",
"sellThreeAmount","sellThreePrice",
"sellFourAmount","sellFourPrice",
"sellFiveAmount","sellFivePrice",
"Date","Time","mark")
Kdt<-transform(Kdt,
nowPrice=as.numeric(as.character(nowPrice)),
yestClose=as.numeric(as.character(yestClose)))
Kdt$nowPrice<-ifelse((Kdt$mark=="03") & (Kdt$nowPrice==0),
as.numeric(as.character(Kdt$yestClose)),
as.numeric(as.character(Kdt$nowPrice)))
#market capitalization
Klist1<-unlist(lapply(id,function(id){
readLines(paste("http://qt.gtimg.cn/r=0.8409869808238q=",
id,sep="")
)}))
Klist1<-substr(Klist1,16,unlist(lapply(Klist1,nchar))-2)
Kdt1<-data.frame(matrix(unlist(strsplit(Klist1,"~")),
byrow=T,ncol=48))
Kdt1<-Kdt1[,c(2,44,45)]
Kdt1<-data.frame(id,Kdt1)
names(Kdt1)<-c("id","stockid","MarketValue","TotalMarketValue")
#merge
Kdt<-merge(Kdt,Kdt1,by="id",all.x=T)
}
if(TYPE=="index"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=s_",id,sep=""),
encoding ="UTF-8")}))
Klist<-substr(Klist,23,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=6))
Kdt<-data.frame(id,Kdt)
names(Kdt)<-c("id","indexname",
"currentPoints","currentPrice",
"changeRate",
"volume_hand","turnOver_million")
}
if(TYPE=="futuresIndex"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=CFF_RE_",id,sep=""),
encoding ="UTF-8")}))
Kid<-substr(Klist,19,nchar(matrix(unlist(strsplit(Klist,"=")),
byrow=T,ncol=2)[,1]))
Klist<-substr(Klist,27,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,",")),byrow=T,ncol=49))
Kdt<-data.frame(Kid,Kdt)
Kdt<-Kdt[c(1:9,15:16)]
names(Kdt)<-c("id","open","high","low",
"currentPice","Amount","turnover",
"holdings","clearing",
"yesterdayClose","yesterdayClearing")
}
if(TYPE=="futures"){
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=",id,sep=""))}))
Klist<-substr(Klist,12,unlist(lapply(Klist,nchar))-2)
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]",perl =T)),
byrow=T,ncol=30))
Kdt<-Kdt[c(1,3,5:8,11:13,16:20)]
names(Kdt)<-c("id","name",
"open","high","low","yesterdayClose",
"currentPice","clearing","yesterdayClearing",
"holdings","amount",
"exchange","nameabbr","date")
}
Kdt
}
id<-"IF1506"
realtimeK(id,TYPE="futuresIndex")
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=CFF_RE_",id,sep=""),
encoding ="UTF-8")}))
Klist
unlist(strsplit(Klist,"[,]|[=\"]"))
Klist<-substr(Klist,18,unlist(lapply(Klist,nchar))-2)
unlist(strsplit(Klist,"[,]|[=\"]"))
Klist<-unlist(lapply(id,function(id){
readLines(paste("http://hq.sinajs.cn/list=CFF_RE_",id,sep=""),
encoding ="UTF-8")}))
Klist<-substr(Klist,19,unlist(lapply(Klist,nchar))-2)
unlist(strsplit(Klist,"[,]|[=\"]"))
Kdt<-data.frame(matrix(unlist(strsplit(Klist,"[,]|[=\"]")),
byrow=T,ncol=51))
Kdt<-Kdt[c(1,3:10,16:17)]
Kdt
names(Kdt)<-c("id","open","high","low",
"currentPice","Amount","turnover",
"holdings","clearing",
"yesterdayClose","yesterdayClearing")
Kdt
